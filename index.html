<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Store Audit Checklist</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            overscroll-behavior: none;
            background-color: #f8f9fe;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(121, 82, 255, 0.1) 2%, transparent 0%), 
                radial-gradient(circle at 75px 75px, rgba(121, 82, 255, 0.1) 2%, transparent 0%);
            background-size: 100px 100px;
        }
        #root {
            position: relative;
            z-index: 1;
        }
        body::before {
            content: '';
            position: fixed;
            top: -20%;
            left: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.2), transparent 70%);
            filter: blur(100px);
            z-index: 0;
            animation: drift 15s infinite alternate ease-in-out;
        }
         body::after {
            content: '';
            position: fixed;
            bottom: -20%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(79, 70, 229, 0.2), transparent 70%);
            filter: blur(120px);
            z-index: 0;
             animation: drift 20s infinite alternate ease-in-out;
        }
        
        @keyframes drift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 60px) scale(1.1); }
        }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .chevron { transform: rotate(180deg); }
        
        @media print {
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                background: none;
            }
            body::before, body::after { display: none; }
            details { page-break-inside: avoid; }
            details[open] { display: block; }
            summary { display: block; }
        }
        .print-prep .print\:hidden { display: none !important; }
        .modal-backdrop {
             animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-content {
            animation: slideUp 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // --- START: Google Sheets Configuration ---
        // IMPORTANT: PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbz4JK4ucG_gTL5t5b7zr4R37gIFyZ2C3O52kNxuKcHhO3_qupt0C6vSl-xD4Hi12Ux7/exec'; 
        
    </script>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDVI7Ij3C9cKHHrHT_tipqew_9FOvAQk0A",
  authDomain: "store-audit-49cdd.firebaseapp.com",
  projectId: "store-audit-49cdd",
  storageBucket: "store-audit-49cdd.firebasestorage.app",
  messagingSenderId: "957701379208",
  appId: "1:957701379208:web:f1a6cd79b54322fdd1fb3d",
  measurementId: "G-GHX5ZBTGLE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function saveQuestionsToFirebase(sections) {
  try {
    const docRef = doc(db, "audit_questions", "default");
    await setDoc(docRef, {
      sections: JSON.parse(JSON.stringify(sections)),
      updatedAt: new Date().toISOString(),
    }, { merge: true });

    console.log("‚úÖ Questions saved to Firebase successfully");
  } catch (err) {
    console.error("‚ùå Error saving questions to Firebase:", err);
    alert("Error saving to Firebase. Please check your connection or Firebase rules.");
  }
}

async function loadQuestionsFromFirebase() {
  try {
    const ref = doc(db, "audit_questions", "default");
    const snapshot = await getDoc(ref);
    if (snapshot.exists()) {
      console.log("‚úÖ Loaded sections from Firebase");
      return snapshot.data().sections || null;
    }
    console.warn("‚ö†Ô∏è No Firebase data found");
    return null;
  } catch (err) {
    console.error("‚ùå Error loading questions:", err);
    return null;
  }
}

function subscribeToQuestions(callback) {
  const ref = doc(db, "audit_questions", "default");
  return onSnapshot(ref, (snapshot) => {
    if (snapshot.exists()) {
      console.log("üî• Realtime update received from Firebase");
      callback(snapshot.data().sections || []);
    }
  });
}

// ‚úÖ Attach to window (important!)
window.saveQuestionsToFirebase = saveQuestionsToFirebase;
window.loadQuestionsFromFirebase = loadQuestionsFromFirebase;
window.subscribeToQuestions = subscribeToQuestions;
</script>
</script>
    <script type="text/babel" data-type="module">
        // In-browser module imports from CDN
        const { useState, useEffect, useCallback, useMemo, StrictMode, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Start of Consolidated Application Code ---

        //============================================
        // UTILS: helpers.ts
        //============================================
        const generateUUID = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (Math.random() * 16) | 0;
                const v = c === 'x' ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        };

        //============================================
        // CONSTANTS: constants.ts
        //============================================
        const SESSION_ID_KEY = 'audit-session-id';
        const QUESTIONS_STORAGE_KEY = 'audit-questions';
        const DEFAULT_SECTIONS = [
            {
                id: 'exterior',
                title: 'Exterior & Storefront',
                emoji: 'üè¢',
                questions: [
                    { id: 'ext1', text: 'Signage clean, well-lit, and in good condition?' },
                    { id: 'ext2', text: 'Windows clean and free of clutter?' },
                    { id: 'ext3', text: 'Entrance clean and inviting?' },
                    { id: 'ext4', text: 'Store hours clearly displayed and accurate?' },
                ],
            },
            {
                id: 'visual',
                title: 'Visual Merchandising & Atmosphere',
                emoji: '‚ú®',
                questions: [
                    { id: 'vis1', text: 'Mannequins styled correctly according to current guidelines?' },
                    { id: 'vis2', text: 'Displays engaging and well-maintained?' },
                    { id: 'vis3', text: 'Lighting effective and all bulbs working?' },
                ],
            },
            {
                id: 'inventory',
                title: 'Stock & Inventory Management',
                emoji: 'üì¶',
                questions: [
                    { id: 'inv1', text: 'Shelves and racks well-stocked and organized?' },
                    { id: 'inv2', text: 'All items have clear and correct price tags?' },
                    { id: 'inv3', text: 'Stockroom organized and accessible?' },
                ],
            },
            {
                id: 'staff',
                title: 'Staff & Customer Experience',
                emoji: 'üòä',
                questions: [
                    { id: 'staff1', text: 'Staff professionally dressed and adhering to uniform policy?' },
                    { id: 'staff2', text: 'Customers greeted promptly upon entry?' },
                    { id: 'staff3', text: 'Staff knowledgeable about products and promotions?' },
                ],
            },
            {
                id: 'safety',
                title: 'Safety, Security & Operations',
                emoji: 'üõ°Ô∏è',
                questions: [
                    { id: 'safe1', text: 'Aisles and walkways clear of hazards?' },
                    { id: 'safe2', text: 'Fire extinguishers accessible and inspected?' },
                    { id: 'safe3', text: 'Security systems (cameras, tags) operational?' },
                ],
            },
        ];


        //============================================
        // SERVICES: pdfService.ts
        //============================================
        const exportToPdf = async (elementId, fileName) => {
            const { jsPDF } = jspdf;
            const reportElement = document.getElementById(elementId);
            if (!reportElement) {
                console.error(`Element with id "${elementId}" not found.`);
                return;
            }

            document.body.classList.add('print-prep');
            try {
                const canvas = await html2canvas(reportElement, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false 
                });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ 
                    orientation: 'portrait', 
                    unit: 'px', 
                    format: [canvas.width, canvas.height] 
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(fileName);
            } catch (error) {
                console.error("Error generating PDF:", error);
            } finally {
                document.body.classList.remove('print-prep');
            }
        };

        //============================================
        // SERVICES: storageService.ts
        //============================================
        const isGoogleSheetConfigured = () => {
            return typeof GOOGLE_SHEET_URL !== 'undefined' && GOOGLE_SHEET_URL && GOOGLE_SHEET_URL !== 'YOUR_GOOGLE_SHEET_WEB_APP_URL';
        }

        const getSessionId = () => {
            let sessionId = localStorage.getItem(SESSION_ID_KEY);
            if (!sessionId) {
                sessionId = generateUUID();
                localStorage.setItem(SESSION_ID_KEY, sessionId);
            }
            return sessionId;
        };

        const saveAuditData = async (sessionId, auditState, allQuestions, isFinal = false) => {
    const dataToSave = { ...auditState, allQuestions };
    const localDataString = JSON.stringify(dataToSave);

    // Always autosave to localStorage for draft progress
    localStorage.setItem(`audit-data-${sessionId}`, localDataString);

    // Only send to Google Sheets when it's a final submission
    if (!isFinal) return;

    if (!isGoogleSheetConfigured()) {
        alert("Google Sheet URL not configured. Data saved locally only.");
        return;
    }

    const payload = {
        action: 'save',
        sessionId,
        data: localDataString
    };

    try {
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
        });
        if (!response.ok) throw new Error(`Network error ${response.status}`);
        console.log('Final audit data saved to Google Sheets');
    } catch (err) {
        console.error('Error submitting to Google Sheets:', err);
    }
};


const loadAuditData = async (sessionId) => {
    if (!isGoogleSheetConfigured()) {
        console.warn('Google Sheet URL not configured. Loading from localStorage.');
        const localData = localStorage.getItem(`audit-data-${sessionId}`);
        return localData ? JSON.parse(localData) : null;
    }

    try {
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                action: "load",
                sessionId: sessionId
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        if (!data || data.length === 0) {
            console.log("No saved data found for this session.");
            return null;
        }

        // Map saved answers to question IDs
        const answers = {};
        data.forEach(item => {
            answers[item.id] = {
                response: item.answer || "unanswered",
                comment: item.comment || ""
            };
        });

        return { answers };
    } catch (error) {
        console.error('Error loading data from Google Sheet:', error);
        const localData = localStorage.getItem(`audit-data-${sessionId}`);
        return localData ? JSON.parse(localData) : null;
    }
};
        const clearAuditData = async (sessionId) => {
            localStorage.removeItem(`audit-data-${sessionId}`);
            if (!isGoogleSheetConfigured()) return;

            const payload = {
                action: 'clear',
                sessionId: sessionId
            };
            
            try {
                 const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok, status: ${response.status}`);
                }
            } catch (error) {
                 console.error('Error clearing remote data from Google Sheet:', error);
            }
        };

        //============================================
        // HOOKS: useChecklist.ts
        //============================================
        const useChecklist = (sections) => {
            const [sessionId] = useState(getSessionId());

            const ALL_QUESTIONS = useMemo(() =>
                sections.flatMap(section =>
                    section.questions.map(question => ({ ...question, section: section.title }))
                ), [sections]);

            const createInitialAnswers = useCallback(() => {
                return ALL_QUESTIONS.reduce((acc, question) => {
                    acc[question.id] = { response: 'unanswered', comment: '' };
                    return acc;
                }, {});
            }, [ALL_QUESTIONS]);
            
            const getInitialState = useCallback(() => ({
                answers: createInitialAnswers(),
                storeName: '',
                auditDate: new Date().toISOString().split('T')[0],
                isSubmitted: false,
            }), [createInitialAnswers]);

            const [auditState, setAuditState] = useState(getInitialState());
            const [isLoaded, setIsLoaded] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const saveTimeoutRef = useRef(null);

            const forceSave = useCallback(async (stateToSave) => {
                const currentState = stateToSave || auditState;
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                setIsSaving(true);
                await saveAuditData(sessionId, currentState, ALL_QUESTIONS);
                setIsSaving(false);
            }, [auditState, sessionId, ALL_QUESTIONS]);

            useEffect(() => {
                const loadData = async () => {
                    const loadedData = await loadAuditData(sessionId);
                    const initialState = getInitialState();
                    if (loadedData) {
                        const loadedAnswers = loadedData.answers || {};
                        const mergedAnswers = { ...initialState.answers };
                        for (const qId in loadedAnswers) {
                            if (qId in initialState.answers) {
                                mergedAnswers[qId] = loadedData.answers[qId];
                            }
                        }
                        setAuditState({
                            ...initialState,
                            ...loadedData,
                            answers: mergedAnswers,
                        });
                    } else {
                       setAuditState(initialState);
                    }
                    setIsLoaded(true);
                };
                loadData();
            }, [sessionId, sections]); 

            useEffect(() => {
    if (!isLoaded || auditState.isSubmitted) return;
    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
    setIsSaving(true);
    saveTimeoutRef.current = window.setTimeout(() => {
        // Save only to localStorage (not Google Sheet)
        localStorage.setItem(`audit-data-${sessionId}`, JSON.stringify({ ...auditState, allQuestions: ALL_QUESTIONS }));
        setIsSaving(false);
    }, 1500);
    return () => { if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current); };
}, [auditState, sessionId, isLoaded, ALL_QUESTIONS]);


            const handleResponseChange = useCallback((questionId, response) => {
                setAuditState(prev => {
                    const currentAnswer = prev.answers[questionId] || { response: 'unanswered', comment: '' };
                    const newResponse = response === currentAnswer.response ? 'unanswered' : response;
                    return { ...prev, answers: { ...prev.answers, [questionId]: { ...currentAnswer, response: newResponse }}};
                });
            }, []);

            const handleCommentChange = useCallback((questionId, comment) => {
                setAuditState(prev => {
                    const currentAnswer = prev.answers[questionId] || { response: 'unanswered', comment: '' };
                    return { ...prev, answers: { ...prev.answers, [questionId]: { ...currentAnswer, comment } }};
                });
            }, []);

            const handleFieldChange = useCallback((field, value) => {
                setAuditState(prev => ({ ...prev, [field]: value }));
            }, []);

            const handleSubmit = useCallback(async () => {
    const finalState = { ...auditState, isSubmitted: true };
    setAuditState(finalState);
    // Only now send to Google Sheets
    await saveAuditData(sessionId, finalState, ALL_QUESTIONS, true);
}, [auditState, sessionId, ALL_QUESTIONS]);


            const resetChecklist = useCallback(async () => {
    // Generate a brand new session ID for the new audit
    const newSession = generateUUID();
    localStorage.setItem(SESSION_ID_KEY, newSession);
    localStorage.removeItem(`audit-data-${sessionId}`);
    setAuditState(getInitialState());
    window.location.reload(); // optional, to refresh form cleanly
}, [sessionId, getInitialState]);


            const { score, maxScore, progress } = useMemo(() => {
                let currentScore = 0;
                let totalPossibleScore = 0;
                const scoreMap = {
                    'yes': 3,
                    'partial': 1,
                    'no': 0,
                    'unanswered': 0
                };
                
                // Calculate scores and max score
                ALL_QUESTIONS.forEach(question => {
                    const answer = auditState.answers[question.id];
                    totalPossibleScore += 3; // Max score for any question is 3 (for 'yes')
                    if (answer && answer.response) {
                        currentScore += scoreMap[answer.response] || 0;
                    }
                });

                const answeredCount = Object.values(auditState.answers).filter(a => a && a.response !== 'unanswered').length;
                const totalCount = ALL_QUESTIONS.length;
                const calculatedProgress = totalCount > 0 ? (answeredCount / totalCount) * 100 : 0;

                return {
                    score: currentScore,
                    maxScore: totalPossibleScore,
                    progress: calculatedProgress
                };
            }, [auditState.answers, ALL_QUESTIONS]);

            return { auditState, progress, score, maxScore, isSaving, handleResponseChange, handleCommentChange, handleFieldChange, handleSubmit, resetChecklist };
        };

        //============================================
        // COMPONENTS
        //============================================
        const Icon = ({ type, className = 'w-5 h-5' }) => {
            const icons = {
                save: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
                download: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
                reset: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 11M20 20l-1.5-1.5A9 9 0 003.5 13" /></svg>,
                spinner: <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
                'check-circle': <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                'exclamation-triangle': <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
                'x-circle': <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
                edit: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
                plus: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>,
                trash: <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            };
            return icons[type] || null;
        };

        const Header = ({ onEditClick, isSubmitted }) => (
            <header className="bg-white/80 backdrop-blur-lg shadow-sm print:shadow-none sticky top-0 z-10">
                <div className="max-w-4xl mx-auto py-3 px-4 md:px-8 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        {/* START OF LOGO INTEGRATION (MODIFIED) */}
                        <div className="w-12 h-12 rounded-full flex items-center justify-center shadow-lg overflow-hidden bg-gray-100">
                             <img 
                                src="https://www.dropbox.com/scl/fi/3w8cuktwjostzrb21pafw/LOGO-2.png?rlkey=crkvpkwg128csjf52s565avoa&st=9e7gee2m&raw=1" 
                                alt="Kasam Fashions Logo" 
                                className="w-full h-full object-contain p-1"
                             />
                        </div>
                        {/* END OF LOGO INTEGRATION (MODIFIED) */}
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">
                            Kasam Fashions
                            <span className="block text-sm font-medium text-gray-500 -mt-1">Store Audit</span>
                        </h1>
                    </div>
                    {!isSubmitted && (
                        <button onClick={onEditClick} className="flex items-center gap-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors duration-200 p-2 rounded-lg hover:bg-indigo-50 print:hidden" aria-label="Edit Questions">
                            <Icon type="edit" className="w-5 h-5"/>
                            <span className="hidden md:inline">Edit Questions</span>
                        </button>
                    )}
                </div>
            </header>
        );

        const ProgressBar = ({ progress }) => {
            const roundedProgress = Math.round(progress);
            return (
                <div>
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-sm font-medium text-gray-600">Completion</span>
                        <span className="text-sm font-bold text-indigo-600">{roundedProgress}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-500 to-indigo-500 h-2.5 rounded-full transition-all duration-500 ease-out" style={{ width: `${roundedProgress}%` }}></div>
                    </div>
                </div>
            );
        };
        
        // --- NEW SCORE CARD COMPONENT ---
        const ScoreCard = ({ score, maxScore }) => {
            const percentage = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
            let colorClass = 'text-gray-600';
            if (percentage >= 80) {
                colorClass = 'text-green-600';
            } else if (percentage >= 50) {
                colorClass = 'text-yellow-600';
            } else if (percentage > 0) {
                colorClass = 'text-red-600';
            }

            return (
                <div className="flex justify-between items-center pt-4 border-t border-gray-200/80 mt-4">
                    <span className="text-sm font-medium text-gray-600 flex items-center gap-2">
                        <svg className="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-7h2v2h-2v-2zm0-5h2v4h-2V6z" clipRule="evenodd"></path></svg>
                        Total Score
                    </span>
                    <span className={`text-xl font-bold ${colorClass}`}>
                        {score} / {maxScore} ({percentage}%)
                    </span>
                </div>
            );
        };
        // --- END NEW SCORE CARD COMPONENT ---

        const ResponseButton = ({ value, currentValue, onClick, children, iconType, disabled = false }) => {
            const isActive = value === currentValue;
            const baseClasses = "flex-1 px-3 py-2.5 text-sm font-semibold rounded-lg flex items-center justify-center gap-2 transition-all duration-200 border-2 outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-70";
            const activeClasses = {
                'yes': 'bg-green-500 border-green-500 text-white shadow-lg transform scale-105 focus-visible:ring-green-500',
                'partial': 'bg-yellow-500 border-yellow-500 text-white shadow-lg transform scale-105 focus-visible:ring-yellow-500',
                'no': 'bg-red-500 border-red-500 text-white shadow-lg transform scale-105 focus-visible:ring-red-500'
            };
            const inactiveClasses = "bg-white border-gray-300 hover:border-gray-400 text-gray-700 hover:bg-gray-50 focus-visible:ring-indigo-500 disabled:bg-gray-100 disabled:hover:border-gray-300";
            
            return (
                <button onClick={onClick} className={`${baseClasses} ${isActive ? activeClasses[value] : inactiveClasses}`} aria-pressed={isActive} disabled={disabled}>
                    <Icon type={iconType} className="w-5 h-5" /> {children}
                </button>
            );
        };

        const ChecklistItem = ({ question, answer, onResponseChange, onCommentChange, isSubmitted }) => (
            <div className="border-b border-gray-100 pb-6 last:border-b-0 print:border-b-2 print:border-gray-300">
                <p className="text-base font-medium text-gray-700 mb-4">{question.text}</p>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                    <ResponseButton value="yes" currentValue={answer.response} onClick={() => onResponseChange(question.id, 'yes')} iconType="check-circle" disabled={isSubmitted}>Yes</ResponseButton>
                    <ResponseButton value="partial" currentValue={answer.response} onClick={() => onResponseChange(question.id, 'partial')} iconType="exclamation-triangle" disabled={isSubmitted}>Partial</ResponseButton>
                    <ResponseButton value="no" currentValue={answer.response} onClick={() => onResponseChange(question.id, 'no')} iconType="x-circle" disabled={isSubmitted}>No</ResponseButton>
                </div>
                <div className="relative">
                    <textarea value={answer.comment} onChange={(e) => onCommentChange(question.id, e.target.value)} placeholder="Add a comment (optional)..." className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:bg-white transition duration-200 text-sm placeholder-gray-500 disabled:bg-gray-100 disabled:cursor-not-allowed" rows={2} disabled={isSubmitted}/>
                </div>
            </div>
        );

        const ChecklistSection = ({ section, answers, onResponseChange, onCommentChange, isSubmitted, defaultOpen = false }) => (
            <details className="bg-white/80 backdrop-blur-lg rounded-xl shadow-lg overflow-hidden print:shadow-none transition-all duration-300 hover:shadow-xl" open={defaultOpen}>
                <summary className="cursor-pointer p-4 md:p-6 bg-gray-50/50 hover:bg-gray-100/70 transition duration-200 flex justify-between items-center print:bg-white">
                    <h3 className="text-lg font-bold text-gray-800 flex items-center gap-3">
                        <span className="text-2xl">{section.emoji}</span>
                        <span>{section.title}</span>
                    </h3>
                    <span className="text-gray-500 transition-transform transform duration-300 chevron">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </span>
                </summary>
                <div className="p-4 md:p-6 border-t border-gray-200/80 space-y-6">
                    {section.questions.map(question => (
                        <ChecklistItem key={question.id} question={question} answer={answers[question.id] || { response: 'unanswered', comment: '' }} onResponseChange={onResponseChange} onCommentChange={onCommentChange} isSubmitted={isSubmitted} />
                    ))}
                </div>
            </details>
        );

        const FloatingActions = ({ isSaving, onExport, onReset, onSubmit, progress, isSubmitted }) => {
            const isComplete = Math.round(progress) >= 100;
            
            return (
                <div className="fixed bottom-4 right-4 md:bottom-8 md:right-8 flex flex-col items-end gap-3 print:hidden">
                    {isSubmitted ? (
                        <div className="flex flex-col items-end gap-3">
                            <div className="flex items-center gap-2 bg-green-100 text-green-800 text-sm font-semibold px-4 py-2 rounded-full shadow-lg">
                                <Icon type="check-circle" /><span>Audit Submitted! üéâ</span>
                            </div>
                            <div className="flex flex-col md:flex-row items-end md:items-center gap-3">
                                <button onClick={onReset} className="bg-indigo-600 text-white px-5 py-2.5 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center gap-2 transition-all duration-200 hover:scale-105">
                                    <Icon type="plus" /><span className="font-bold">Start New Audit</span>
                                </button>
                                <button onClick={onExport} className="bg-green-600 text-white w-auto px-4 py-2.5 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center justify-center gap-2 transition-transform duration-200 hover:scale-105">
                                    <Icon type="download" /><span className="hidden md:inline">Export PDF</span>
                                </button>
                            </div>
                        </div>
                    ) : (
                        <>
                            <div className={`transition-opacity duration-300 ${isSaving ? 'opacity-100' : 'opacity-0'}`}>
                                <div className="flex items-center gap-2 bg-gray-800 text-white text-xs font-semibold px-3 py-1.5 rounded-full shadow-lg">
                                    <Icon type="spinner" className="w-4 h-4 animate-spin" /><span>Saving... üíæ</span>
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row items-end md:items-center gap-3">
                                <button 
                                    onClick={onSubmit} 
                                    className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-2.5 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center gap-2 transition-all duration-200 hover:scale-105 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:shadow-lg"
                                    disabled={!isComplete}
                                    title={!isComplete ? `Complete the checklist to submit (${Math.round(progress)}%)` : "Submit Final Audit"}>
                                    <Icon type="check-circle" /><span className="font-bold">Submit</span>
                                </button>
                                <button onClick={onExport} className="bg-green-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center justify-center transition-transform duration-200 hover:scale-105"><Icon type="download" /></button>
                                <button onClick={onReset} className="bg-red-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center justify-center transition-transform duration-200 hover:scale-105"><Icon type="reset" /></button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const QuestionEditor = ({ sections: initialSections, onSave, onCancel }) => {
            const [sections, setSections] = useState(JSON.parse(JSON.stringify(initialSections)));

            const handleSectionChange = (sectionId, newTitle) => {
                setSections(sections.map(s => s.id === sectionId ? { ...s, title: newTitle } : s));
            };

            const handleQuestionChange = (sectionId, questionId, newText) => {
                setSections(sections.map(s => s.id === sectionId ? {
                    ...s,
                    questions: s.questions.map(q => q.id === questionId ? { ...q, text: newText } : q)
                } : s));
            };
            
            const addQuestion = (sectionId) => {
                const newQuestion = { id: generateUUID(), text: 'New Question' };
                 setSections(sections.map(s => s.id === sectionId ? { ...s, questions: [...s.questions, newQuestion] } : s));
            };
            
            const deleteQuestion = (sectionId, questionId) => {
                 setSections(sections.map(s => s.id === sectionId ? { ...s, questions: s.questions.filter(q => q.id !== questionId) } : s));
            };

            const addSection = () => {
                const newSection = { id: generateUUID(), title: 'New Section', emoji: 'üÜï', questions: []};
                setSections([...sections, newSection]);
            };
            
            const deleteSection = (sectionId) => {
                if(window.confirm('Are you sure you want to delete this entire section and all its questions?')) {
                    setSections(sections.filter(s => s.id !== sectionId));
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 modal-backdrop print:hidden">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-content">
                        <div className="p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">Edit Checklist Questions</h2>
                        </div>
                        <div className="p-6 space-y-6 overflow-y-auto">
                           {sections.map(section => (
                               <div key={section.id} className="p-4 border rounded-lg bg-gray-50/50">
                                   <div className="flex items-center gap-2 mb-4">
                                       <input type="text" value={section.title} onChange={(e) => handleSectionChange(section.id, e.target.value)} className="text-lg font-bold w-full p-1 -ml-1 rounded focus:ring-2 focus:ring-indigo-300 outline-none bg-transparent"/>
                                       <button onClick={() => deleteSection(section.id)} className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100"><Icon type="trash" className="w-5 h-5"/></button>
                                   </div>
                                   <div className="space-y-3 pl-4 border-l-2 border-indigo-200">
                                       {section.questions.map(q => (
                                           <div key={q.id} className="flex items-center gap-2">
                                               <input type="text" value={q.text} onChange={e => handleQuestionChange(section.id, q.id, e.target.value)} className="w-full p-1 rounded focus:ring-2 focus:ring-indigo-300 outline-none"/>
                                               <button onClick={() => deleteQuestion(section.id, q.id)} className="text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100"><Icon type="trash" className="w-4 h-4"/></button>
                                           </div>
                                       ))}
                                       <button onClick={() => addQuestion(section.id)} className="flex items-center gap-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800"><Icon type="plus"/>Add Question</button>
                                   </div>
                               </div>
                           ))}
                           <button onClick={addSection} className="flex items-center gap-2 text-sm text-green-600 font-semibold hover:text-green-800 mt-4"><Icon type="plus"/>Add Section</button>
                        </div>
                        <div className="p-4 bg-gray-50 border-t flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-semibold">Cancel</button>
                            <button onClick={() => onSave(sections)} className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Save Changes</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        //============================================
        // APP: Main Application Component
        //============================================
        const App = () => {
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [sections, setSections] = useState(DEFAULT_SECTIONS);
            const [loadingQuestions, setLoadingQuestions] = useState(true);

useEffect(() => {
    const fetchQuestions = async () => {
        try {
            // ‚úÖ Try loading from Firebase first
            const firebaseSections = await window.loadQuestionsFromFirebase();
            
            if (firebaseSections && Array.isArray(firebaseSections)) {
                console.log("‚úÖ Loaded sections from Firebase");
                setSections(firebaseSections);
                localStorage.setItem(QUESTIONS_STORAGE_KEY, JSON.stringify(firebaseSections));
            } else {
                // ‚ùå Firebase empty, use local storage or fallback
                const local = localStorage.getItem(QUESTIONS_STORAGE_KEY);
                if (local) {
                    console.warn("‚ö†Ô∏è Firebase empty, using local storage");
                    setSections(JSON.parse(local));
                } else {
                    console.warn("‚ö†Ô∏è No Firebase data found, using default questions");
                    setSections(DEFAULT_SECTIONS);
                }
            }

            // ‚úÖ Subscribe to live updates *after initial load*
            const unsubscribe = window.subscribeToQuestions((updatedSections) => {
                if (updatedSections && updatedSections.length > 0) {
                    console.log("üî• Realtime update from Firebase");
                    setSections(updatedSections);
                    localStorage.setItem(QUESTIONS_STORAGE_KEY, JSON.stringify(updatedSections));
                }
            });

            return () => unsubscribe && unsubscribe(); // Cleanup listener
        } catch (error) {
            console.error("‚ùå Error loading questions from Firebase:", error);
            const local = localStorage.getItem(QUESTIONS_STORAGE_KEY);
            setSections(local ? JSON.parse(local) : DEFAULT_SECTIONS);
        } finally {
            setLoadingQuestions(false);
        }
    };

    fetchQuestions();
}, []);
            useEffect(() => {
                if (!isGoogleSheetConfigured()) {
                    setTimeout(() => {
                        alert("Your Google Sheet URL is not configured. Your audit data will be saved locally to this browser only. Follow the instructions in index.html to set up cloud storage with Google Sheets.");
                    }, 1000);
                }
            }, []);

            const {
                auditState, progress, score, maxScore, isSaving, handleResponseChange, // <-- Now receiving score/maxScore
                handleCommentChange, handleFieldChange, handleSubmit, resetChecklist
            } = useChecklist(sections);

            const { storeName, auditDate, isSubmitted, answers } = auditState;

            const handleExport = () => {
                const fileName = `Audit-Report-${storeName.replace(/\s+/g, '-') || 'Store'}-${auditDate}.pdf`;
                exportToPdf('audit-report', fileName);
            };

            const handleReset = () => {
                const message = isSubmitted
                    ? 'Are you sure you want to start a new audit?'
                    : 'Are you sure you want to reset your progress? All current changes will be lost.';
                if (window.confirm(message)) {
                    resetChecklist();
                }
            };

            const handleFinalSubmit = async () => {
                if (!storeName || !auditDate) {
                    alert('Please fill in the Store Name and Date of Audit before submitting.');
                    return;
                }
                if (window.confirm('Are you sure you want to submit? You cannot make any changes after submission.')) {
                    await handleSubmit();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const handleSaveQuestions = async (newSections) => {
    try {
        setSections(newSections);
        localStorage.setItem(QUESTIONS_STORAGE_KEY, JSON.stringify(newSections));
        await window.saveQuestionsToFirebase(newSections);
        setIsEditorOpen(false);
        alert("‚úÖ Checklist questions updated successfully!");
        // üîÅ No reload needed, UI will sync live via onSnapshot
    } catch (err) {
        console.error("‚ùå Error saving updated questions:", err);
        alert("Error saving to Firebase. Please check your internet connection or Firebase rules.");
    }
};
            return (
                <div className="min-h-screen font-sans text-gray-800">
                    <Header onEditClick={() => setIsEditorOpen(true)} isSubmitted={isSubmitted} />
                    <main className="max-w-4xl mx-auto p-4 md:p-8 pb-32">
                        <div id="audit-report">
                            <div className="bg-white/80 backdrop-blur-lg p-6 rounded-xl shadow-lg mb-6 print:shadow-none">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üìù Audit Details</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label htmlFor="storeName" className="block text-sm font-medium text-gray-700">Store Name</label>
                                        <input type="text" id="storeName" value={storeName} onChange={e => handleFieldChange('storeName', e.target.value)} disabled={isSubmitted} className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                                    </div>
                                    <div>
                                        <label htmlFor="auditDate" className="block text-sm font-medium text-gray-700">Date of Audit</label>
                                        <input type="date" id="auditDate" value={auditDate} onChange={e => handleFieldChange('auditDate', e.target.value)} disabled={isSubmitted} className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white/80 backdrop-blur-lg p-6 rounded-xl shadow-lg mb-6 print:shadow-none">
                                <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üìä Audit Progress & Score</h2>
                                <ProgressBar progress={progress} />
                                <ScoreCard score={score} maxScore={maxScore} /> {/* <-- New ScoreCard integration */}
                            </div>
                            <div className="space-y-4">
                                {sections.map((section, index) => (
                                    <ChecklistSection
                                        key={section.id}
                                        section={section}
                                        answers={answers}
                                        onResponseChange={handleResponseChange}
                                        onCommentChange={handleCommentChange}
                                        isSubmitted={isSubmitted}
                                        defaultOpen={index === 0}
                                    />
                                ))}
                                
                                {/* --- Summary & Action Plan Section --- */}
<div className="bg-white/80 backdrop-blur-lg p-6 rounded-xl shadow-lg mb-6 print:shadow-none mt-10">
    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üìù Summary & Action Plan</h2>
    
    {/* Key Strengths */}
    <div className="mb-6">
        <h3 className="text-lg font-semibold text-gray-700 mb-2">Key Strengths:</h3>
        {[1, 2].map((i) => (
            <input
                key={`strength-${i}`}
                type="text"
                placeholder={`Strength ${i}`}
                value={auditState[`strength${i}`] || ""}
                onChange={(e) => handleFieldChange(`strength${i}`, e.target.value)}
                disabled={isSubmitted}
                className="w-full mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm disabled:bg-gray-100"
            />
        ))}
    </div>

    {/* Opportunities for Improvement */}
    <div className="mb-6">
        <h3 className="text-lg font-semibold text-gray-700 mb-3">Top 3 Opportunities for Improvement:</h3>
        {[1, 2, 3].map((i) => (
            <div key={`opportunity-${i}`} className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
                <input
                    type="text"
                    placeholder={`Opportunity ${i}`}
                    value={auditState[`opp${i}`] || ""}
                    onChange={(e) => handleFieldChange(`opp${i}`, e.target.value)}
                    disabled={isSubmitted}
                    className="col-span-1 md:col-span-1 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-gray-100"
                />
                <input
                    type="text"
                    placeholder="Action"
                    value={auditState[`oppAction${i}`] || ""}
                    onChange={(e) => handleFieldChange(`oppAction${i}`, e.target.value)}
                    disabled={isSubmitted}
                    className="p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-gray-100"
                />
                <input
                    type="text"
                    placeholder="By (Name/Date)"
                    value={auditState[`oppBy${i}`] || ""}
                    onChange={(e) => handleFieldChange(`oppBy${i}`, e.target.value)}
                    disabled={isSubmitted}
                    className="p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-gray-100"
                />
            </div>
        ))}
    </div>

    {/* Signatures */}
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Auditor Signature:</label>
            <input
                type="text"
                placeholder="Auditor Name or Signature"
                value={auditState.auditorSignature || ""}
                onChange={(e) => handleFieldChange('auditorSignature', e.target.value)}
                disabled={isSubmitted}
                className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-gray-100"
            />
        </div>
        <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Store Manager Signature:</label>
            <input
                type="text"
                placeholder="Manager Name or Signature"
                value={auditState.managerSignature || ""}
                onChange={(e) => handleFieldChange('managerSignature', e.target.value)}
                disabled={isSubmitted}
                className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-gray-100"
            />
        </div>
    </div>
</div>

                            </div>
                        </div>
                    </main>
                    <FloatingActions 
                        isSaving={isSaving} 
                        onExport={handleExport} 
                        onReset={handleReset} 
                        onSubmit={handleFinalSubmit}
                        progress={progress}
                        isSubmitted={isSubmitted}
                    />
                    {isEditorOpen && !isSubmitted && <QuestionEditor sections={sections} onSave={handleSaveQuestions} onCancel={() => setIsEditorOpen(false)} />}
                </div>
            );
        };

        //============================================
        // RENDER: Mount the App
        //============================================
        const rootElement = document.getElementById('root');
        if (!rootElement) {
            throw new Error("Could not find root element to mount to");
        }
        const root = createRoot(rootElement);
        root.render(
            <StrictMode>
                <App />
            </StrictMode>
        );

    </script>
</body>
</html>
